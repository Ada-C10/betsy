<%= render partial: "/layouts/flash_errs" %>

<p>
  <strong>User ID:</strong>
  <%= @user.uid %>
</p>

<p>
  <strong>Username:</strong>
  <%= @user.username %>
</p>

<p>
  <strong>Email:</strong>
  <%= @user.email %>
</p>



<section class="merchant-actions">
  <%= link_to 'View Your Bakes', user_products_path(@user), class: "btn btn-info" %>
  <%= link_to 'List a New Bake', new_user_product_path(@user), class: "sell-link btn btn-info" %> |
  <%= link_to 'View Categories', categories_path, class: "btn btn-info" %>
</section>


<h2>LISTED BAKES</h2>
<table class="show_table table">
  <tr>
    <th>NAME</th>
    <th>PRICE</th>
    <th>QUANTITY</th>
    <th>RATING</th>
    <th>STATUS</th>
    <th>      </th>
  </tr>

  <tbody>
  <% if @user.products.empty? %>
    <%= "No Products List to Sell" %>
  <% else %>
    <% @user.products.each do |product| %>
      <tr>
        <td> <%= link_to "#{product.prod_name}", edit_product_path(product.id)%></td>
        <td> <%= format_price(product.price)%></td>
        <td> <%= product.inv_qty %></td>
        <td> <%= product.avg_rating %></td>
         <% if product.active %>
            <td>ACTIVE</td>
            <td><%= link_to "RETIRE", product_status_path(product), class: "btn btn-warning ", method: :patch%></td>
          <% else %>
            <td>RETIRED</td>
            <td><%= link_to "ACTIVATE", product_status_path(product), class: "btn btn-success", method: :patch%></td>
        <% end %>
      </tr>
    <% end %>
  <% end %>
  </tbody>
</table>



<h2>ORDER FULFILLMENT</h2>
<table class="show_table table">
  <tr>
    <th>ORDER #</th>
    <th>ITEM</th>
    <th>PRICE</th>
    <th>QUANTITY</th>
    <th>SUBTOTAL</th>
    <th>ITEM STATUS</th>
    <th>ORDER STATUS</th>
  </tr>

  <tbody>
    <% sold = @user.find_orders %>
    <% if sold.empty? %>
      <%= "No Products Have Sold" %>
    <% else %>
      <% sold.each do |product| %>
        <tr>
          <% or_item = OrderItem.find_by(product_id: product.id) %>
          <td> <%= link_to "#{or_item.order.id}", edit_order_path(or_item.order.id) %></td>
          <td> <%= link_to "#{product.prod_name}", edit_product_path(product.id)%></td>
          <td> <%= format_price(product.price)%></td>
          <td> <%= or_item.qty %></td>
          <td> <%= format_price(product.price * or_item.qty)  %></td>
               <% if or_item.shipped %>
                   <td>SHIPPED</td>
               <% elsif !or_item.shipped && or_item.order.status == "Paid"%>
                   <td> PAID
                    <%= link_to "CONFIRM SHIPPED", ship_item_path(product), class: "btn btn-outline-info btn-sm", method: :patch%>
                  </td>
               <%else %>
                 <td>PENDING PAYMENT</td>
               <% end %>
          <% ord = Order.find(or_item.order.id) %>
          <td><%= ord.status.upcase %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<h2>REVENUE</h2>
<table class="show_table table">
  <tr>
    <th>PENDING</th>
    <th>PAID</th>
    <th>COMPLETE</th>
    <th>CANCELLED</th>
    <th>TOTAL</th>
  </tr>

  <tbody>
  <% sold = @user.find_orders %>
  <% if sold.empty? %>
    <%= "No Products Have Sold" %>
  <% else %>
      <tr>
        <td> <%= @user.revenue("Pending") %></td>
        <td> <%= @user.revenue("Paid") %></td>
        <td> <%= @user.revenue("Complete") %></td>
        <td> <%= @user.revenue("Cancelled") %></td>
        <td> <%= @user.revenue("Total") %></td>

      </tr>
    <% end %>
  </tbody>
</table>


<%# view order fulfillment%>
<%= link_to 'Back', root_path %>
